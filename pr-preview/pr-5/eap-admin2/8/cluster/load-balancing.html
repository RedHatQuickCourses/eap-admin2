<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Load Balancing JBoss EAP Instances :: Red Hat JBoss EAP Administration II</title>
    <link rel="prev" href="standalone-cluster-tcp.html">
    <link rel="next" href="../security/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img
          src="../../../_/img/redhat-logo.png"
          height="40px"
          alt="Red Hat"
        /></a>
      <a
        class="navbar-item"
        style="font-size: 24px; color: white"
        href="../../.."
      >Red Hat JBoss EAP Administration II</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a
          class="navbar-item"
          href="https://github.com/RedHatQuickCourses/eap-admin2/issues"
          target="_blank"
        >Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="eap-admin2" data-version="8">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Red Hat JBoss EAP Administration II</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../adv-install/index.html">Advanced Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adv-install/response-files.html">Automated Installer Script</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../adv-install/adv-patching.html">Patches and Updates</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../domain/index.html">JBoss EAP Domain Mode</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../domain/domain-mode.html">JBoss EAP Domain Mode Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../domain/domain-deployment.html">Deploying Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../domain/jvm-config.html">JVM Configuration</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Clustering and High Availability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="standalone-cluster-udp.html">Standalone Mode Clustering (UDP)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="standalone-cluster-tcp.html">Standalone Mode Clustering (TCP)</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="load-balancing.html">Load Balancing JBoss EAP Instances</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../security/index.html">Securing EAP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/eap-security.html">Enabling or Disabling the EAP Management (Web) Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/tls-console.html">Enabling TLS/SSL in the EAP Web Console</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../security/sso-console.html">EAP Web Console Single Sign-On using OIDC</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../openshift/index.html">EAP on OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../openshift/eap-container.html">EAP Container</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../openshift/deploy-openshift.html">Deploy EAP Applications on OpenShift</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Red Hat JBoss EAP Administration II</span>
    <span class="version">8</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Red Hat JBoss EAP Administration II</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">8</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Red Hat JBoss EAP Administration II</a></li>
    <li><a href="index.html">Clustering and High Availability</a></li>
    <li><a href="load-balancing.html">Load Balancing JBoss EAP Instances</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Load Balancing JBoss EAP Instances</h1>
<div class="sect1">
<h2 id="_references"><a class="anchor" href="#_references"></a>References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.4/html/configuration_guide/configuring_high_availability#configuring_jboss_eap_load_balancer">JBoss EAP Load Balancer</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exercise_load_balancing_jboss_eap_instances_using_mod_undertow"><a class="anchor" href="#_exercise_load_balancing_jboss_eap_instances_using_mod_undertow"></a>Exercise: Load Balancing JBoss EAP Instances using mod_undertow</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_pre_requisites"><a class="anchor" href="#_pre_requisites"></a>Pre-requisites</h3>
<div class="ulist">
<ul>
<li>
<p>For the exercises in this chapter, you will need <strong>three (3)</strong> servers or VMs with JBoss EAP 8.0 installed on them. Your IP addresses maybe different. Replace the values according to your set up.</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Host</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>IP Address</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Role</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>controller.example.com</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.124.10</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Load Balancer</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eap1.example.com</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.124.11</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cluster Node</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>eap2.example.com</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>192.168.124.12</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Cluster Node</code></p></td>
</tr>
</tbody>
</table>
</li>
<li>
<p>Install JBoss EAP 8.0 on all three servers. We recommend using the zip file installation method and installing it in a separate directory to prevent overwriting the configuration of the instance that you have used in previous exercises. For all VMs, create a user named <code>jboss</code> that will run the JBoss EAP instance.</p>
</li>
<li>
<p>Configure UDP or TCP based clustering on <code>eap1</code> and <code>eap2</code> by referring to the previous sections in this chapter. Ensure the appropriate TCP and UDP ports are open in the firewall as outlined in the previous sections.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_steps"><a class="anchor" href="#_steps"></a>Steps</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inspect the default <code>$JBOSS_HOME/standalone/configuration/standalone-load-balancer.xml</code>. This file is much much smaller compared to the default <code>standalone-*.xml</code> files. It contains only a few modules pertaining to load balancing and web serving. You will mainly configure the load balancer in the <code>undertow</code> subsystem section of this file.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">...
&lt;extensions&gt;
  &lt;extension module="org.jboss.as.logging"/&gt;
  &lt;extension module="org.wildfly.extension.elytron"/&gt;
  &lt;extension module="org.wildfly.extension.io"/&gt;
  &lt;extension module="org.wildfly.extension.undertow"/&gt;
...
&lt;/extensions&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>The load balancer will receive HTTP requests on port <code>8080</code> and then load balance the requests between the two standalone EAP instances <code>eap1</code> and <code>eap2</code> running on two separate similarly named VMs. Like you did in previous sections, you need to allow the traffic on this port through the operating system firewall. The load balancer also communicates with the backend EAP instances on TCP port <code>8009</code>. You need to also open this port on the <code>eap1</code> and <code>eap2</code> instances. Start by opening port <code>8080</code> on the <code>controller</code> VM:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">root@controller $ firewall-cmd --zone=public --permanent --add-port=8080/tcp
root@controller $ firewall-cmd --reload</code></pre>
</div>
</div>
</li>
<li>
<p>Also, open TCP port <code>8009</code> on both <code>eap1</code> and <code>eap2</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">root@eap1 $ firewall-cmd --zone=public --permanent --add-port=8009/tcp
root@eap1 $ firewall-cmd --reload</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">root@eap2 $ firewall-cmd --zone=public --permanent --add-port=8009/tcp
root@eap2 $ firewall-cmd --reload</code></pre>
</div>
</div>
</li>
<li>
<p>Start the two backend EAP instances (You can start either the UDP or TCP based cluster like in previous sections). In this case, I am starting the UDP based cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[jboss@eap1 bin] $ ./standalone.sh -c standalone-full-ha.xml \
  -Djboss.bind.address=192.168.124.11 \
  -Djboss.bind.address.private=192.168.124.11 \
  -Djboss.node.name=eap1 \
  -Djboss.messaging.cluster.password=redhat123</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[jboss@eap2 bin] $ ./standalone.sh -c standalone-full-ha.xml \
  -Djboss.bind.address=192.168.124.12 \
  -Djboss.bind.address.private=192.168.124.12 \
  -Djboss.node.name=eap2 \
  -Djboss.messaging.cluster.password=redhat123</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The node name is required to use the sticky session feature.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Now, start the load balancer on the <code>controller</code> VM.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">[jboss@eap1 bin] $ ./standalone.sh -c standalone-load-balancer.xml \
  -Djboss.bind.address=192.168.124.10
...
WFLYUT0003: Undertow 2.3.10.SP3-redhat-00001 starting
WFLYUT0012: Started server default-server.
WFLYUT0006: Undertow HTTP listener default listening on 192.168.124.10:8080
...
UT005039: Undertow starts mod_cluster proxy advertisements on /224.0.1.105:23364 with frequency 10000 ms
WFLYSRV0212: Resuming server
...
WFLYSRV0025: JBoss EAP 8.0.0.GA (WildFly Core 21.0.5.Final-redhat-00001) started in 9772ms - Started 109 of 120 services (43 services are lazy, passive or on-demand) - Server configuration file in use: standalone-load-balancer.xml</code></pre>
</div>
</div>
</li>
<li>
<p>If you have not done so already, download the <a href="https://github.com/RedHatQuickCourses/eap-qc-apps/releases/download/eap8-lp/cluster.war" class="bare">https://github.com/RedHatQuickCourses/eap-qc-apps/releases/download/eap8-lp/cluster.war</a> WAR file. Copy the WAR file to the <code>/tmp</code> folder on both <code>eap1</code> and <code>eap2</code> and deploy it as outlined in the previous sections.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Do <strong>NOT</strong> deploy the WAR file on the <code>controller</code> VM running the load balancer!
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Configure the load balancer to load balance requests between the two EAP instances. Execute the following EAP CLI commands on the <strong>controller</strong> VM. To configure a new load balancer, create a <code>cluster-handler</code> reverse proxy in the <code>undertow</code> subsystem:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">jboss@controller bin $ ./jboss-cli.sh --connect
[standalone@localhost:9990 /] /subsystem=undertow/configuration=handler/reverse-proxy=cluster-handler:add
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</li>
<li>
<p>Create a <code>remote-eap1</code> outbound socket binding to <code>eap1</code> on TCP port <code>8009</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=remote-eap1:add(host=192.168.124.11, port=8009)
{"outcome" =&gt; "success"}</code></pre>
</div>
</div>
</li>
<li>
<p>Create a reference to the <code>remote-eap1</code> socket binding in the <code>undertow</code> subsystem. Bind it with the <code>AJP</code> scheme and the context path for the application:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/subsystem=undertow/configuration=handler/reverse-proxy=cluster-handler/host=eap1:add(outbound-socket-binding=remote-eap1, scheme=ajp, instance-id=eap1, path=/cluster)</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For sticky sessions to work correctly, the <code>instance-id</code> attribute should have the same
value specified by the <code>jboss.node.name</code> system property during backend EAP instance startup.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Repeat the above steps for creating socket bindings and handlers for <code>eap2</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/socket-binding-group=standard-sockets/remote-destination-outbound-socket-binding=remote-eap2:add(host=192.168.124.12, port=8009)

/subsystem=undertow/configuration=handler/reverse-proxy=cluster-handler/host=eap2:add(outbound-socket-binding=remote-eap2, scheme=ajp, instance-id=eap2, path=/cluster)</code></pre>
</div>
</div>
</li>
<li>
<p>Finally, create a new reverse proxy location named <code>/cluster</code>, and refer it to the <code>cluster-handler</code> handler:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/subsystem=undertow/server=default-server/host=default-host/location=\/cluster:add(handler=cluster-handler)

:reload</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Note the <code>\</code> before the <code>/cluster</code> URL. It&#8217;s an escape handler because the URL needs an explicit <code>/</code>, which also happens to be the namespacing operator for the EAP CLI.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You have now configured the load balancer for the application. To view the changes from the default configuration, see <a href="https://github.com/RedHatQuickCourses/eap-qc-apps/blob/main/admin2/load-balancer.diff" class="bare">https://github.com/RedHatQuickCourses/eap-qc-apps/blob/main/admin2/load-balancer.diff</a></p>
</li>
<li>
<p>The load balancer in EAP comes with session stickiness enabled. So you can test the clustering behavior using a browser. Navigate to the load balancer URL at <a href="http://192.168.124.10:8080/cluster" class="bare">http://192.168.124.10:8080/cluster</a>. The load balancer may forward the request to either <code>eap1</code> or <code>eap2</code>, and your output maybe different. In my case, the load balancer forwarded the request to <code>eap1</code>.</p>
</li>
<li>
<p>Refresh the page a few times and observe the counter value incrementing by one for every request. Also note that the load balancer always sends requests to the same EAP instance (in my case <code>eap1</code>) that served the first request from this browser client.</p>
</li>
<li>
<p>Kill the EAP node that is currently serving requests. Observe that the cluster detects the failure and rebalances.</p>
</li>
<li>
<p>Make another request to the load balancer at <a href="http://192.168.124.10:8080/cluster" class="bare">http://192.168.124.10:8080/cluster</a>. Observe that requests are now sent to the other remaining live node - <code>eap2</code>, but the counter value is not reset to zero, but keeps incrementing on every page request.</p>
</li>
<li>
<p>Optional. Test failback. Restart the node you killed earlier. Kill the node that was serving the latest request. Send more requests to the load balancer, and verify that the counter value is not reset, but keeps on incrementing.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="standalone-cluster-tcp.html">Standalone Mode Clustering (TCP)</a></span>
  <span class="next"><a href="../security/index.html">Securing EAP</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
